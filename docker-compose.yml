version: '3.8'

services:
  # Jitsi Web - Frontend
  web:
    image: jitsi/web:stable-9584
    container_name: jitsi_web
    restart: unless-stopped
    ports:
      - '${HTTP_PORT:-8000}:80'
      - '${HTTPS_PORT:-8443}:443'
    volumes:
      - ./config/web:/config:Z
      - ./config/web/interface_config.js:/usr/share/jitsi-meet/interface_config.js:ro
      - ./config/web/config.js:/usr/share/jitsi-meet/config.js:ro
    environment:
      - ENABLE_AUTH=${ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
      - ENABLE_LETSENCRYPT=${ENABLE_LETSENCRYPT:-0}
      - ENABLE_HTTP_REDIRECT=${ENABLE_HTTP_REDIRECT:-0}
      - ENABLE_TRANSCRIPTIONS=${ENABLE_TRANSCRIPTIONS:-0}
      - DISABLE_HTTPS=${DISABLE_HTTPS:-1}
      - JICOFO_AUTH_USER=focus
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_AUTH_DOMAIN=auth.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_BOSH_URL_BASE=http://prosody:5280
      - XMPP_MUC_DOMAIN=muc.${XMPP_DOMAIN:-meet.jitsi}
      - TZ=${TZ:-UTC}
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost:8000}
    networks:
      - meet.jitsi
    depends_on:
      - prosody

  # Prosody - XMPP Server
  prosody:
    image: jitsi/prosody:stable-9584
    container_name: jitsi_prosody
    restart: unless-stopped
    expose:
      - '5222'
      - '5347'
      - '5280'
    volumes:
      - ./config/prosody:/config:Z
      - ./config/prosody/prosody.cfg.lua:/config/prosody.cfg.lua:ro
    environment:
      - AUTH_TYPE=${AUTH_TYPE:-internal}
      - ENABLE_AUTH=${ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
      - GLOBAL_MODULES=${GLOBAL_MODULES:-}
      - GLOBAL_CONFIG=${GLOBAL_CONFIG:-}
      - LDAP_URL=${LDAP_URL:-}
      - LDAP_BASE=${LDAP_BASE:-}
      - LDAP_BINDDN=${LDAP_BINDDN:-}
      - LDAP_BINDPW=${LDAP_BINDPW:-}
      - LDAP_FILTER=${LDAP_FILTER:-}
      - LDAP_AUTH_METHOD=${LDAP_AUTH_METHOD:-}
      - LDAP_VERSION=${LDAP_VERSION:-}
      - LDAP_USE_TLS=${LDAP_USE_TLS:-}
      - LDAP_TLS_CIPHERS=${LDAP_TLS_CIPHERS:-}
      - LDAP_TLS_CHECK_PEER=${LDAP_TLS_CHECK_PEER:-}
      - LDAP_TLS_CACERT_FILE=${LDAP_TLS_CACERT_FILE:-}
      - LDAP_TLS_CACERT_DIR=${LDAP_TLS_CACERT_DIR:-}
      - LDAP_START_TLS=${LDAP_START_TLS:-}
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_AUTH_DOMAIN=auth.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_GUEST_DOMAIN=guest.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_MUC_DOMAIN=muc.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_MODULES=${XMPP_MODULES:-}
      - XMPP_MUC_MODULES=${XMPP_MUC_MODULES:-}
      - XMPP_INTERNAL_MUC_MODULES=${XMPP_INTERNAL_MUC_MODULES:-}
      - XMPP_RECORDER_DOMAIN=recorder.${XMPP_DOMAIN:-meet.jitsi}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - JIGASI_XMPP_USER=${JIGASI_XMPP_USER:-}
      - JIGASI_XMPP_PASSWORD=${JIGASI_XMPP_PASSWORD:-}
      - JIBRI_RECORDER_USER=recorder
      - JIBRI_RECORDER_PASSWORD=${JIBRI_RECORDER_PASSWORD}
      - JIBRI_XMPP_USER=${JIBRI_XMPP_USER:-}
      - JIBRI_XMPP_PASSWORD=${JIBRI_XMPP_PASSWORD:-}
      - TZ=${TZ:-UTC}
    networks:
      - meet.jitsi

  # Jicofo - Jitsi Conference Focus
  jicofo:
    image: jitsi/jicofo:stable-9584
    container_name: jitsi_jicofo
    restart: unless-stopped
    volumes:
      - ./config/jicofo:/config:Z
    environment:
      - AUTH_TYPE=${AUTH_TYPE:-internal}
      - ENABLE_AUTH=${ENABLE_AUTH:-0}
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_AUTH_DOMAIN=auth.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=prosody
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JICOFO_ENABLE_BRIDGE_HEALTH_CHECKS=${JICOFO_ENABLE_BRIDGE_HEALTH_CHECKS:-false}
      - TZ=${TZ:-UTC}
    networks:
      - meet.jitsi
    depends_on:
      - prosody

  # JVB - Jitsi Videobridge
  jvb:
    image: jitsi/jvb:stable-9584
    container_name: jitsi_jvb
    restart: unless-stopped
    ports:
      - '${JVB_PORT:-10000}:10000/udp'
      - '${JVB_TCP_PORT:-4443}:4443/tcp'
    volumes:
      - ./config/jvb:/config:Z
      - ./config/jvb/sip-communicator.properties:/config/sip-communicator.properties:ro
    environment:
      - DOCKER_HOST_ADDRESS=${DOCKER_HOST_ADDRESS:-}
      - XMPP_AUTH_DOMAIN=auth.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=prosody
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=${JVB_PORT:-10000}
      - JVB_TCP_HARVESTER_DISABLED=${JVB_TCP_HARVESTER_DISABLED:-false}
      - JVB_TCP_PORT=${JVB_TCP_PORT:-4443}
      - JVB_STUN_SERVERS=${JVB_STUN_SERVERS:-meet-jit-si-turnrelay.jitsi.net:443}
      - JVB_ENABLE_APIS=rest,colibri
      - ENABLE_COLIBRI_WEBSOCKET=1
      - JVB_WS_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - JVB_WS_SERVER_ID=${JVB_WS_SERVER_ID:-jvb}
      - TZ=${TZ:-UTC}
      # Multitrack recorder configuration
      - ENABLE_MULTITRACK_RECORDER=1
      - MULTITRACK_RECORDER_ENDPOINT=ws://recorder:8989/record
    networks:
      - meet.jitsi
    depends_on:
      - prosody

  # Multitrack Recorder
  recorder:
    image: jitsi/jitsi-multitrack-recorder:latest
    container_name: jitsi_multitrack_recorder
    restart: unless-stopped
    ports:
      - '8989:8989'
    volumes:
      - ./recordings:/recordings:Z
      - ./scripts/finalize-recording.sh:/scripts/finalize-recording.sh:ro
    environment:
      - RECORDING_DIR=/recordings
      - ENABLE_AUTO_RECORDING=${ENABLE_AUTO_RECORDING:-1}
      - FINALIZE_SCRIPT=/scripts/finalize-recording.sh
      - TZ=${TZ:-UTC}
    networks:
      - meet.jitsi

networks:
  meet.jitsi:
    driver: bridge
